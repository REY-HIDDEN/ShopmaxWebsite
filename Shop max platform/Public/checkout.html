<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - ShopMax</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --secondary: #64748b;
            --accent: #10b981;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --shadow: 0 4px 24px rgba(79,70,229,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        body { background: var(--bg); color: var(--text); min-height: 100vh; }

        /* Navbar */
        .navbar {
            background: #1e293b;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .navbar .logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: #38bdf8;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: auto;
        }
        .navbar a.back-btn {
            color: #94a3b8;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .navbar a.back-btn:hover { color: white; }

        /* Page Layout */
        .page-container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 768px) {
            .page-container { grid-template-columns: 1fr; }
        }

        h2 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        h2 i { color: var(--primary); }

        /* Card */
        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.75rem;
            box-shadow: var(--shadow);
        }

        /* Order Items */
        .order-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.85rem 0;
            border-bottom: 1px solid var(--border);
        }
        .order-item:last-child { border-bottom: none; }
        .order-item img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }
        .order-item-info { flex: 1; }
        .order-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .order-item-meta {
            font-size: 0.8rem;
            color: var(--secondary);
        }
        .order-item-price {
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .empty-cart {
            text-align: center;
            padding: 3rem 0;
            color: var(--secondary);
        }
        .empty-cart i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.4; }
        .empty-cart p { margin-bottom: 1rem; }

        /* Delivery Form */
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--secondary);
            margin-bottom: 0.35rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.7rem 1rem;
            border: 1.5px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-family: 'Poppins', sans-serif;
            color: var(--text);
            transition: border-color 0.2s;
            background: #f8fafc;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        /* Summary Card */
        .summary-line {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            color: var(--secondary);
            border-bottom: 1px solid var(--border);
        }
        .summary-line:last-of-type { border-bottom: none; }
        .summary-total {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0 0;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text);
        }
        .summary-total span:last-child { color: var(--primary); }

        .btn-place-order {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-top: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 0.6rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            letter-spacing: 0.02em;
        }
        .btn-place-order:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(79,70,229,0.3); }
        .btn-place-order:active { transform: translateY(0); }
        .btn-place-order:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Login Notice */
        .login-notice {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            color: #92400e;
            margin-bottom: 1rem;
            display: none;
        }
        .login-notice a { color: var(--primary); text-decoration: underline; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            z-index: 9999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 360px;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }

        /* Success screen */
        .success-screen {
            text-align: center;
            padding: 3rem 2rem;
            display: none;
        }
        .success-screen .check-circle {
            width: 80px;
            height: 80px;
            background: #dcfce7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #16a34a;
            margin: 0 auto 1.5rem;
        }
        .success-screen h2 { font-size: 1.5rem; color: var(--text); margin-bottom: 0.5rem; }
        .success-screen p { color: var(--secondary); margin-bottom: 1.5rem; }
        .btn-continue {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-continue:hover { background: var(--primary-dark); }

        /* Payment badge */
        .payment-badges {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .badge-item {
            padding: 0.3rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.35rem;
            font-size: 0.75rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* Payment Methods */
        .payment-methods-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .payment-tab {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .payment-tab i { font-size: 1.5rem; color: var(--secondary); }
        .payment-tab span { font-size: 0.9rem; font-weight: 500; }
        .payment-tab:hover { background: #f8fafc; border-color: var(--primary); }
        .payment-tab.active { border-color: var(--primary); background: #eef2ff; }
        .payment-tab.active i { color: var(--primary); }

        .payment-details { display: none; padding-top: 1rem; border-top: 1px solid var(--border); }
        .payment-details.active { display: block; }
        
        .bank-details {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px dashed var(--secondary);
            font-size: 0.85rem;
        }
        .bank-details p { margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
        .bank-details p strong { color: var(--text); }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="logo">
            <i class="fas fa-shopping-bag"></i> ShopMax
        </a>
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Continue Shopping
        </a>
    </nav>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMsg">Message</span>
    </div>

    <div class="page-container">
        <!-- Left: Order Items + Delivery Info -->
        <div>
            <!-- Order Items -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <h2><i class="fas fa-shopping-cart"></i> Your Order</h2>
                <div id="orderItemsContainer">
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                        <a href="index.html" class="btn-continue"><i class="fas fa-store"></i> Shop Now</a>
                    </div>
                </div>

                <!-- Success Screen -->
                <div class="success-screen" id="successScreen">
                    <div class="check-circle"><i class="fas fa-check"></i></div>
                    <h2>Order Placed Successfully!</h2>
                    <p>Your order has been received and is being processed. You can track it in your dashboard.</p>
                    <a href="user_dashboard.html" class="btn-continue">
                        <i class="fas fa-tachometer-alt"></i> View My Orders
                    </a>
                </div>
            </div>

            <!-- Delivery Details -->
            <div class="card" id="deliveryCard">
                <h2><i class="fas fa-map-marker-alt"></i> Delivery Details</h2>
                <div class="login-notice" id="loginNotice">
                    <i class="fas fa-exclamation-triangle"></i>
                    You must be <a href="login/login.html">logged in</a> to place an order.
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="firstName" placeholder="John">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="lastName" placeholder="Doe">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="emailField" placeholder="john@example.com" readonly>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone" placeholder="+1 (555) 000-0000">
                </div>
                <div class="form-group">
                    <label>Street Address</label>
                    <input type="text" id="address" placeholder="123 Main St, Apt 4B">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="city" placeholder="Kigali">
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" id="country" placeholder="Rwanda">
                    </div>
                </div>
                <div class="form-group">
                    <label>Order Notes (optional)</label>
                    <textarea id="notes" rows="2" placeholder="Special delivery instructions..."></textarea>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="card" id="paymentCard" style="margin-top: 1.5rem;">
                <h2><i class="fas fa-credit-card"></i> Payment Method</h2>
                <div class="payment-methods-tabs">
                    <div class="payment-tab active" data-method="card" onclick="selectPayment('card')">
                        <i class="fas fa-credit-card"></i>
                        <span>Card Payment</span>
                    </div>
                    <div class="payment-tab" data-method="eft" onclick="selectPayment('eft')">
                        <i class="fas fa-university"></i>
                        <span>Instant EFT</span>
                    </div>
                </div>

                <!-- Card Details -->
                <div id="cardDetails" class="payment-details active">
                    <div class="form-group">
                        <label>Card Number</label>
                        <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="text" id="expiry" placeholder="MM/YY">
                        </div>
                        <div class="form-group">
                            <label>CVV</label>
                            <input type="password" id="cvv" placeholder="123">
                        </div>
                    </div>
                </div>

                <!-- EFT Details -->
                <div id="eftDetails" class="payment-details">
                    <div class="bank-details">
                        <p>Please use your Order ID as reference:</p>
                        <p><strong>Bank:</strong> Bank of Kigali</p>
                        <p><strong>Account Name:</strong> ShopMax Ltd</p>
                        <p><strong>Account Number:</strong> 000123-456789-01</p>
                        <p><strong>Branch:</strong> Musanze  Main</p>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--secondary); margin-top: 1rem;">
                        <i class="fas fa-info-circle"></i> Place your order first, then complete the transfer. Your order will be processed once payment is confirmed.
                    </p>
                </div>
            </div>
        </div>

        <!-- Right: Order Summary -->
        <div class="card" id="summaryCard">
            <h2><i class="fas fa-receipt"></i> Summary</h2>
            <div id="summaryLines"></div>
            <div class="summary-total">
                <span>Total</span>
                <span id="summaryTotal">$0.00</span>
            </div>
            <button class="btn-place-order" id="placeOrderBtn" onclick="placeOrder()">
                <i class="fas fa-lock"></i> Place Order
            </button>
            <div class="payment-badges">
                <span class="badge-item"><i class="fas fa-shield-alt"></i> Secure</span>
                <span class="badge-item"><i class="fas fa-undo"></i> 30-day Returns</span>
                <span class="badge-item"><i class="fas fa-truck"></i> Fast Delivery</span>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        const token = localStorage.getItem('token');

        // ── Render Items ──────────────────────────────────────────
        function renderCart() {
            const container = document.getElementById('orderItemsContainer');
            const summaryLines = document.getElementById('summaryLines');
            const summaryTotal = document.getElementById('summaryTotal');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                        <a href="index.html" class="btn-continue"><i class="fas fa-store"></i> Shop Now</a>
                    </div>`;
                summaryLines.innerHTML = '';
                summaryTotal.textContent = '$0.00';
                document.getElementById('placeOrderBtn').disabled = true;
                return;
            }

            // Items
            container.innerHTML = cart.map(item => `
                <div class="order-item">
                    <img src="${item.image}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/64'">
                    <div class="order-item-info">
                        <div class="order-item-name">${item.name}</div>
                        <div class="order-item-meta">
                            Qty: ${item.quantity}
                            ${item.size ? ` &bull; Size: ${item.size}` : ''}
                            ${item.color ? ` &bull; <span style="display:inline-block;width:12px;height:12px;background:${item.color};border-radius:50%;vertical-align:middle;"></span>` : ''}
                        </div>
                    </div>
                    <div class="order-item-price">$${(Number(item.price) * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');

            // Summary
            const subtotal = cart.reduce((s, i) => s + Number(i.price) * i.quantity, 0);
            const shipping = subtotal >= 50 ? 0 : 5.99;
            const total = subtotal + shipping;

            summaryLines.innerHTML = `
                <div class="summary-line"><span>Subtotal (${cart.reduce((s,i)=>s+i.quantity,0)} items)</span><span>$${subtotal.toFixed(2)}</span></div>
                <div class="summary-line"><span>Shipping</span><span>${shipping === 0 ? '<span style="color:#10b981">Free</span>' : '$' + shipping.toFixed(2)}</span></div>
            `;
            summaryTotal.textContent = `$${total.toFixed(2)}`;
        }

        // ── Prefill user info ─────────────────────────────────────
        async function prefillUser() {
            if (!token) {
                document.getElementById('loginNotice').style.display = 'block';
                document.getElementById('placeOrderBtn').disabled = true;
                return;
            }
            try {
                const res = await fetch(`${API}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Auth failed');
                const user = await res.json();
                currentUser = user;

                document.getElementById('emailField').value = user.email || '';
                if (user.fullname) {
                    const parts = user.fullname.split(' ');
                    document.getElementById('firstName').value = parts[0] || '';
                    document.getElementById('lastName').value = parts.slice(1).join(' ') || '';
                }
            } catch (e) {
                document.getElementById('loginNotice').style.display = 'block';
                document.getElementById('placeOrderBtn').disabled = true;
            }
        }

        // ── Place Order ───────────────────────────────────────────
        async function placeOrder() {
            if (!token) {
                showToast('Please log in first!', 'error');
                setTimeout(() => window.location.href = 'login/login.html', 1500);
                return;
            }
            if (cart.length === 0) { showToast('Your cart is empty!', 'error'); return; }

            const subtotal = cart.reduce((s, i) => s + Number(i.price) * i.quantity, 0);
            const shipping = subtotal >= 50 ? 0 : 5.99;
            const total = subtotal + shipping;

            const btn = document.getElementById('placeOrderBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Placing Order...';

            try {
                const res = await fetch(`${API}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        items: cart.map(i => ({ id: i.id, quantity: i.quantity, price: Number(i.price) })),
                        total_amount: total,
                        payment_method: selectedPaymentMethod
                    })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to place order');

                // Clear cart
                localStorage.removeItem('cart');
                cart = [];

                // Show success
                document.getElementById('orderItemsContainer').style.display = 'none';
                document.getElementById('successScreen').style.display = 'block';
                document.getElementById('deliveryCard').style.display = 'none';
                document.getElementById('summaryCard').style.display = 'none';
                showToast('Order placed successfully!', 'success');

            } catch (err) {
                showToast(err.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-lock"></i> Place Order';
            }
        }

        // ── Toast ─────────────────────────────────────────────────
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            toast.className = `toast ${type} show`;
            toast.querySelector('i').className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // ── Payment Selection ─────────────────────────────────────
        let selectedPaymentMethod = 'card';
        function selectPayment(method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.method === method);
            });
            document.querySelectorAll('.payment-details').forEach(d => {
                d.classList.toggle('active', d.id === `${method}Details`);
            });
        }

        // ── Init ──────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            renderCart();
            prefillUser();
        });
    </script>
</body>
</html>
